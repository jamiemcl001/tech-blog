<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>

  <title>Enabling Multi-Region Restricted Communications with AWS VPC Peering & Route 53 Private Hosted Zones</title>
  <meta name='description' content="Hi again,">
  <link rel='canonical' href="https://jamiemcl.tech//awsvpc/2020/01/11/multi-vpc-communications/">
  <link rel='alternate' type='application/rss+xml' title='Jamie McLeish's Blog - Tech Ramblings' href="https://jamiemcl.tech//feed.xml">

  <style>
    

    html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}/*! normalize.css v5.0.0 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:0.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item}canvas{display:inline-block}template{display:none}[hidden]{display:none}body,h1,h2,h3,h4,h5,h6,blockquote,p,pre,dl,dd,ol,ul,figure,hr,fieldset,legend{margin:0;padding:0}li>ol,li>ul{margin-bottom:0}table{border-collapse:collapse;border-spacing:0}address,h1,h2,h3,h4,h5,h6,blockquote,p,pre,dl,ol,ul,figure,hr,table,fieldset{margin-bottom:32px}dd,ol,ul{list-style-position:inside;margin-left:16px}@-webkit-keyframes spin{100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spin{100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.icon{position:relative;display:inline-block;width:25px;height:25px;overflow:hidden;fill:currentColor}.icon__cnt{width:100%;height:100%;background:inherit;fill:inherit;pointer-events:none;transform:translateX(0);-ms-transform:translate(0.5px, -0.3px)}.icon--m{width:50px;height:50px}.icon--l{width:100px;height:100px}.icon--xl{width:150px;height:150px}.icon--xxl{width:200px;height:200px}.icon__spinner{position:absolute;top:0;left:0;width:100%;height:100%}.icon--ei-spinner .icon__spinner,.icon--ei-spinner-2 .icon__spinner{-webkit-animation:spin 1s steps(12) infinite;animation:spin 1s steps(12) infinite}.icon--ei-spinner-3 .icon__spinner{-webkit-animation:spin 1.5s linear infinite;animation:spin 1.5s linear infinite}.icon--ei-sc-facebook{fill:#3b5998}.icon--ei-sc-github{fill:#333}.icon--ei-sc-google-plus{fill:#dd4b39}.icon--ei-sc-instagram{fill:#3f729b}.icon--ei-sc-linkedin{fill:#0976b4}.icon--ei-sc-odnoklassniki{fill:#ed812b}.icon--ei-sc-skype{fill:#00aff0}.icon--ei-sc-soundcloud{fill:#f80}.icon--ei-sc-tumblr{fill:#35465c}.icon--ei-sc-twitter{fill:#55acee}.icon--ei-sc-vimeo{fill:#1ab7ea}.icon--ei-sc-vk{fill:#45668e}.icon--ei-sc-youtube{fill:#e52d27}.icon--ei-sc-pinterest{fill:#bd081c}.icon--ei-sc-telegram{fill:#0088cc}.highlight{margin:0;background:#fff}.highlighter-rouge .highlight{background:#FAFAFA}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}body{color:#323232;font-size:19px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";line-height:32px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}*::selection{color:#fff;background:#00A0FF}a{text-decoration:none;color:#323232;transition:.4s}a:hover,a:active,a:focus{text-decoration:underline}img{display:block;max-width:100%;font-style:italic;margin:0 auto}hr{height:1px;margin:32px 0;border:0;background-color:#E9EFF3}h1,h2,h3,h4,h5,h6{font-weight:inherit;line-height:initial;font-weight:600}h1{font-size:36px}h2{font-size:28px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}blockquote{padding-left:16px;border-left:3px solid #2B5F72}pre,code{font-family:Courier,monospace;background-color:#FAFAFA}pre{overflow:auto;padding:32px;margin-bottom:16px;font-size:16px;line-height:25px;white-space:pre}li code,p code{padding:4px 8px}input[type='text'],input[type='tel'],input[type='number'],input[type='email'],select,textarea{width:100%;padding:16px;border:1px solid #E9EFF3;border-radius:0;outline:none;background-color:#fff;font-size:14px;appearance:none;transition:.4s}input[type='text']:hover,input[type='text']:active,input[type='text']:focus,input[type='tel']:hover,input[type='tel']:active,input[type='tel']:focus,input[type='number']:hover,input[type='number']:active,input[type='number']:focus,input[type='email']:hover,input[type='email']:active,input[type='email']:focus,select:hover,select:active,select:focus,textarea:hover,textarea:active,textarea:focus{border:1px solid #323232}.o-grid{margin:0 auto;display:flex;flex-wrap:wrap;max-width:800px}.o-grid:after{content:'';display:table;clear:both}.o-grid .o-grid{margin-right:-16px;margin-left:-16px;padding:0}.o-grid--full{max-width:100vw}.o-grid__col{width:100%;float:left;padding-right:16px;padding-left:16px}.o-grid__col--1-4-s{width:25%}.o-grid__col--1-3-s{width:33.3333333333%}.o-grid__col--2-4-s{width:50%}.o-grid__col--3-4-s{width:75%}.o-grid__col--4-4-s{width:100%}@media (min-width: 40em){.o-grid__col--1-4-m{width:25%}.o-grid__col--1-3-m{width:33.3333333333%}.o-grid__col--2-4-m{width:50%}.o-grid__col--3-4-m{width:75%}}@media (min-width: 64em){.o-grid__col--1-4-l{width:25%}.o-grid__col--1-3-l{width:33.3333333333%}.o-grid__col--2-4-l{width:50%}.o-grid__col--3-4-l{width:75%}}.o-grid__col--full{width:100%}.o-grid__col--center{margin:0 auto}.o-grid__col--end{margin-left:auto}.o-wrapper{padding:32px 0}.c-off-canvas-container{display:flex;min-height:100vh;flex-direction:column}.c-off-canvas-container .o-wrapper{flex:1 0 auto}.o-plain-list{margin:0;padding:0;list-style:none}.c-header__inner{padding:16px 0;border-bottom:1px solid #E9EFF3}.c-header__icon{vertical-align:middle}.c-logo__link{font-size:19px;font-weight:900;transition:.4s}.c-logo__link:hover,.c-logo__link:active,.c-logo__link:focus{color:#00A0FF;text-decoration:none}.c-nav__item{font-size:16px}.c-nav__link{display:block;transition:.4s}.c-nav__link--current{color:#00A0FF}.home-template .c-nav__link--current:not(:hover){color:#323232}.c-nav__link:hover,.c-nav__link:active,.c-nav__link:focus{color:#00A0FF;text-decoration:none}.c-off-canvas-toggle{float:right;position:relative;top:8px;z-index:10;height:19px;width:25px;cursor:pointer}.c-off-canvas-toggle__icon{position:absolute;left:0;height:1px;width:25px;background:#323232;cursor:pointer}.c-off-canvas-toggle__icon:before,.c-off-canvas-toggle__icon:after{content:'';display:block;height:100%;background-color:inherit;transition:.4s}.c-off-canvas-toggle__icon:before{transform:translateY(16px)}.c-off-canvas-toggle__icon:after{transform:translateY(7px)}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon{height:2px;background-color:transparent}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:before,.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:after{position:relative;visibility:visible;background:#323232}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:before{top:11px;transform:rotate(-45deg)}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:after{top:9px;transform:rotate(45deg)}.c-off-canvas-toggle--close{top:0;float:none;display:block;margin-left:auto}html,body{overflow-x:hidden}.c-off-canvas-content{position:fixed;top:0;right:0;width:300px;height:100%;padding:24px 32px;background-color:#fff;transform:translate3d(300px, 0, 0)}.c-off-canvas-container{transform:translate3d(0, 0, 0);transition:transform .4s cubic-bezier(0.16, 0.68, 0.43, 0.99)}.c-off-canvas-container.is-active{transform:translate3d(-300px, 0, 0)}.c-off-canvas-container.is-active:after{position:fixed;top:0;right:0;bottom:0;left:0;content:'';background-color:rgba(0,0,0,0.2)}.c-tags a{display:inline-block;padding:4px 16px;margin:0 8px 4px 0;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";line-height:25px;background-color:#FAFAFA;transition:.4s}.c-tags a:hover,.c-tags a:active,.c-tags a:focus{text-decoration:none;background-color:#FAFAFA}@media (max-width: 39.99em){.c-tags{margin-bottom:22px}}.c-btn{display:inline-block;padding:8px 32px;cursor:pointer;transition:.4s;text-align:center;vertical-align:middle;white-space:nowrap;line-height:inherit;border:0;border-radius:0;color:#fff;background-color:#207cdf;font-size:16px}.c-btn:hover,.c-btn:active,.c-btn:focus{text-decoration:none;background-color:#238cf6}.c-btn--full{width:100%}.c-btn--small{padding:4px 16px}.c-post-card{display:block;padding:32px 0;word-break:break-word;border-bottom:1px solid #E9EFF3}.c-post-card--first{padding-top:0}.c-post-card--last{padding-bottom:0;border-bottom:0}.c-post-card__title{margin-bottom:10px;font-size:19px;font-weight:600;transition:.4s}@media (min-width: 40em){.c-post-card__title{font-size:28px}}.c-post-card__excerpt{margin-bottom:10px}.c-post-card__date{display:block;color:#2B5F72;direction:ltr;font-size:12px;font-weight:600;line-height:22px;text-transform:uppercase}.c-post-card:hover{color:#323232;text-decoration:none}.c-post-card:hover .c-post-card__title{color:#00A0FF}.c-pagination{text-transform:uppercase;transition:.4s}.c-pagination:hover,.c-pagination:active,.c-pagination:focus{color:#00A0FF;text-decoration:none}.c-pagination__text{position:relative;font-size:14px;letter-spacing:2px}.c-pagination__text--prev{left:-16px}.c-pagination__text--next{right:-16px}.c-pagination__icon{vertical-align:text-top}.c-pagination__icon--prev{left:-8px}.c-pagination__icon--next{right:-8px}.c-post{margin:0 auto;max-width:740px}.c-post__title{font-size:24px;margin-bottom:16px}@media (min-width: 40em){.c-post__title{font-size:28px}}.c-post__date{position:relative;padding-top:16px;display:block;text-align:center;margin-bottom:16px;font-size:14px;font-weight:600;line-height:22px;color:#2B5F72}.c-post__date:after{position:absolute;content:'';top:0;left:50%;height:1px;width:64px;background:#FAFAFA;transform:translateX(-50%)}.c-post__image{margin:0 auto 16px}.c-content a:not(.c-btn){text-decoration:underline;text-decoration-skip:ink}.c-content a:not(.c-btn):hover,.c-content a:not(.c-btn):active,.c-content a:not(.c-btn):focus{color:#00A0FF}.twitter-tweet,.fluid-width-video-wrapper{margin-bottom:16px !important}.c-social-nav__item{display:inline-block}.c-social-nav__item a:hover,.c-social-nav__item a:active,.c-social-nav__item a:visited{text-decoration:none}.c-social-nav__icon{fill:#323232;vertical-align:middle;transition:.4s}.c-social-nav__icon:hover,.c-social-nav__icon:active,.c-social-nav__icon:focus{fill:#00A0FF}#disqus_thread{max-width:800px;display:flex;margin:0 auto;padding:16px}.c-footer{padding:32px 0;background-color:#FAFAFA}.u-hidden{display:none}.u-hidden-visually{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.u-font-medium{font-size:16px;line-height:25px}.u-font-small{font-size:14px;line-height:22px}.u-font-tiny{font-size:12px;line-height:19px}.u-text-left{text-align:left}.u-text-right{text-align:right}.u-text-center{text-align:center}.u-text-justify{text-align:justify}.u-inline{display:inline}.u-block{display:block}.u-inline-block{display:inline-block}.u-left{float:left}.u-right{float:right}.u-clearfix:after{content:'';display:table;clear:both}

  </style>
</head>

<body>

  <!-- Google Analytics Code -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152720365-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-152720365-1');
</script>
<!-- End Google Analytics Code -->

  <div class='js-off-canvas-container c-off-canvas-container'>
    <header class='c-header'>

  <div class='o-grid'>
    <div class='o-grid__col o-grid__col--full'>
      <div class='c-header__inner'>

        <div class='o-grid'>
          <div class='o-grid__col o-grid__col--3-4-s'>
            <div class='c-logo u-text-left'>
              <a class='c-logo__link' href='/'>Jamie McLeish's Blog - Tech Ramblings</a>
            </div>
          </div>

          <div class='o-grid__col o-grid__col--1-4-s'>
            <label class='js-off-canvas-toggle c-off-canvas-toggle' aria-label='Toggle navigation'>
              <span class='c-off-canvas-toggle__icon'></span>
            </label>
          </div>

          <div class='o-grid__col o-grid__col--1-4-s'>
            <div class='c-off-canvas-content'>
              <label class='js-off-canvas-toggle c-off-canvas-toggle c-off-canvas-toggle--close'>
                <span class='c-off-canvas-toggle__icon'></span>
              </label>

              <ul class='c-nav o-plain-list '>
                
  

  
    
      <li class='c-nav__item' role='presentation'>
        <a class='c-nav__link' href='/contact.html'>Contact Me</a>
      </li>
    
  

  
    
  

  
    
  

              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</header>

    



<div class='o-wrapper'>

  <div class='o-grid'>
    <div class='o-grid__col'>
      <article class='c-post' itemscope itemtype='http://schema.org/BlogPosting'>

        <h1 class='c-post__title u-text-center'>Enabling Multi-Region Restricted Communications with AWS VPC Peering & Route 53 Private Hosted Zones</h1>

        <time class='c-post__date' datetime='2020-01-11T17:42:00+00:00' itemprop='datePublished'>11 Jan 2020</time>

        <div class='c-content' itemprop='articleBody'>
          

          <p>Hi again,</p>

<p>I’ve recently encountered another problem when using AWS for my side projects. I have two EC2 instances in different regions, and I want to be able to easily communicate between the two services without assigning public IPs to each of them. To be clear, it’s not an actual problem in AWS, but is something that took me a little while to get to grips with, so feel it was worthy of a blog post.</p>

<p>I’m conscious of the fact that I want to make this example as easy to follow as possible - so we’ll work with the following example:</p>

<p>Let’s say I have a server running in the <code class="highlighter-rouge">eu-west-1</code> region in AWS. This is an extremely simple server app, that when invoked with the path <code class="highlighter-rouge">/say-hello?name=Angela</code> it will return the following response:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, Angela!
</code></pre></div></div>

<p>For convenience I’ve pushed a repository to the Docker Hub that will easily start a server that will do just this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run -dt --rm -p 80:8080 jamiemcl001/say-hello-server:latest
</code></pre></div></div>

<p>Let’s say that we have another service running in a different region (lets say North Virginia or <code class="highlighter-rouge">us-east-1</code>). If we presume that this new EC2 instance needs to consume the service in the other region then there are a couple of ways that we could do this.</p>

<p>First off, we could ensure that the first service has a publicly accessible endpoint, and set up our security groups so that port 80 could always be accessed via the outside world. Now this doesn’t seem so bad with our very contrived example, but what if we actually had sensitive data returned as part of this API call? I know that I wouldn’t feel too comfortable about having that available for anyone to hit and potentially hack…</p>

<p>So, what’s our other option? We could ensure that our server has no publicly accessible IP address and instead look to communicate from within our private VPC’s? This is far more desirable, but at the same time, just how easy is it?</p>

<p>Well it turns out that it’s very easy if we had two services sat in the same VPC that wanted to communicate with each other. In the AWS console we would see something like:</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_15_02_04.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_15_02_04.png" /></p>

<p>Now we could easily just run a cURL command on another EC2 instance in the same VPC and successfully see our response. Running <code class="highlighter-rouge">curl ip-172-30-0-224.eu-west-1.compute.internal/say-hello?name=Angela</code> gives us back our expected <code class="highlighter-rouge">Hello, Angela!</code> response!</p>

<p>The problem arises when we try and hit the endpoint <code class="highlighter-rouge">ip-172-30-0-224.eu-west-1.compute.internal</code> from an instance that isn’t in the same VPC as the other. It will simply fail to resolve it and instead we’ll see an error like <code class="highlighter-rouge">ping: ip-172-30-0-224.eu-west-1.compute.internal: Name or service not known</code>. So, how do we get around this now???</p>

<h2 id="creating-a-vpc-peering-connection">Creating a VPC Peering Connection</h2>

<p>If we go to the VPC console in AWS we can see an option down the sidebar which is named “Peering Connections”. Creating a new Peering Connection will allow us to set up routing in AWS which means that the two individual VPCs will be able to see one another. Click on “Create Peering Connection” and we will go through all of the options…</p>

<p>First off you will want to begin with copying the ID of the VPC you would like your North Virginia VPC to connect to. So if we change regions to <code class="highlighter-rouge">eu-west-1</code> and take a look we will see the only VPC we have available in Ireland is as follows:</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_15_24_33.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_15_24_33.png" /></p>

<p>Make a note of the VPC ID (and the IPv4 CIDR block as we will be needing that later on in this post), and then switch regions back to <code class="highlighter-rouge">us-east-1</code>, so that we can set up our peering connection.</p>

<p>Now that we have the ID and are back in our selected region we can input all of the information required to setup the connection. When you click on the VPC (Requester)* checkbox you will be presented with a dropdown box of all the VPCs in your current region. As we have only one we can go ahead and select it immediately.</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_15_20_18.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_15_20_18.png" /></p>

<p>The only other thing we need to change from the defaults is that the VPC we would like to peer with is in another region, and we need to paste in the ID of the VPC we want to connect with in Ireland. Once you click “Create Peering Connection” it will set up a peering request that we will need to go ahead and accept in the other region. Let’s go ahead and change our region back to <code class="highlighter-rouge">eu-west-1</code> so that we can accept it…</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_15_31_51.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_15_31_51.png" /></p>

<p>If we right click on the row of the peering connection then we are presented with the option to Accept the peering connection. If we click this then a popup will show just to present us with all of the information of the connection and we can hit accept and have it be enabled.</p>

<p><em>Note that a popup will immediately show to ask you to set up the routing tables. We will do this, but not just yet. We want to enable one more thing first…</em></p>

<p>Once the peering connection has been created we want to make it so that our service that is located in the US can resolve to the private hostnames in our <code class="highlighter-rouge">eu-west-1</code> VPC. In order to do this, select the connection and right click. Among the options, there is an option to “Edit DNS Settings” - lets set this up by clicking this and we’ll see the following screen:</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_15_39_41.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_15_39_41.png" /></p>

<p>Selecting the option “Accepter DNS resolution” means that the hostname we were trying to resolve earlier from the US service (<code class="highlighter-rouge">ip-172-30-0-224.eu-west-1.compute.internal</code>) will now actually be able to resolve successfully, so lets select it and hit save.</p>

<p>Now that we have set up the peering connection correctly we need to ensure that our US service actually knows how to route requests that are intended for the <code class="highlighter-rouge">eu-west-1</code> service through the peering connection, and not just drop those requests on the floor. To do this we need to first change our region back to <code class="highlighter-rouge">us-east-1</code> and then go into the “Route Tables” section of the VPC console.</p>

<p>You’ll need to go ahead and select the route table associated with the VPC that we have just set up the peering connection for, and then right click and select “Edit Routes”. (This is where we’ll need the IPv4 CIDR block from our European region, as I mentioned earlier…)</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_15.48.28.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_15.48.28.png" /></p>

<p>We’ll want to go ahead and hit “Add route” and paste in the IPv4 CIDR block for our <code class="highlighter-rouge">eu-west-1</code> VPC, so that all IP calls/DNS requests that resolve to the that block will be routed through the peering connection. If we click on the target dropdown we’ll want to select “Peering Connection” and then the name of the Peering connection we inputted when we first created it. Hit save and this will begin to propagate through all of our VPC.</p>

<p>Now we want to enable bi-directional communication - so we’ll go ahead and change the DNS settings for the peering connection to allow hostname resolving from the acceptor VPC (note that we’ll have to change the DNS settings in our <code class="highlighter-rouge">us-east-1</code> region to allow the acceptor to resolve the hostnames), and then setup routing in our <code class="highlighter-rouge">eu-west-1</code> VPC to route calls to <code class="highlighter-rouge">10.0.0.16</code> (as this is the CIDR block for our US VPC) through the same peering connection. This will enable our service in Europe to communicate back with the US VPC.</p>

<p>With all of these changes, if we now SSH into the US EC2 instance we can try and make our API call once again:</p>

<p><code class="highlighter-rouge">curl ip-172-30-0-224.eu-west-1.compute.internal/say-hello?name=Angela</code> will return us with <code class="highlighter-rouge">Hello, Angela!</code> 🎉🎉🎉</p>

<h2 id="taking-it-one-step-further-with-route-53-private-hosted-zones">Taking it one step further with Route 53 Private Hosted Zones</h2>

<p>OK, so now we can hit an endpoint from a different VPC - job done, right? Well we could go one step further and make it so that instead of hitting the endpoint <code class="highlighter-rouge">ip-172-30-0-224.eu-west-1.compute.internal</code> directly, we could hit an endpoint like, say, <code class="highlighter-rouge">api.internal</code> and be able to resolve in the same way as before. But how do we do this?</p>

<p>Amazon Route53 is a fully fledged DNS service, and one of it’s features is “Private Hosted Zones”. This feature allows you to create DNS entries that will be accessible to services within associated VPCs.</p>

<p>We’ll start off by creating a new Private Hosted Zone. We’ll do this by going to Route53 and clicking “Create Hosted Zone”, and we can fill in the form with the following details:</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_17_03_18.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_17_03_18.png" /></p>

<p>By default, the “Type” will be “Public Hosted Zone” - this means that it will be for a domain name that is publicly available to everyone on the internet. We don’t want this - we only want the records contained within this zone to be available to services inside our VPCs. We will want to go ahead and select one of the VPCs that we intend to use, so I’ve gone ahead and selected the <code class="highlighter-rouge">eu-west-1</code> VPC. At the moment you can only select one VPC (at the moment you can only select the one VPC when creating it so we’ll retrospectively add the second VPC after.</p>

<p>Now that we’ve created this <code class="highlighter-rouge">internal</code> hosted zone we can go ahead and add a record for the <code class="highlighter-rouge">api</code> subdomain. Click “Create Record Set” and we’ll create a CNAME record which points the <code class="highlighter-rouge">api</code> subdomain to the previously unmemorable <code class="highlighter-rouge">ip-172-30-0-224.eu-west-1.compute.internal</code> domain, and now that is done. If we were to allow the Route53 DNS services to propagate (which tends to be pretty quick in my experience) - we could then go into any EC2 instance in our EU VPC and hit <code class="highlighter-rouge">api.internal/say-hello?name=Angela</code> and we would get the response that we expect…</p>

<p>But, what we want is to be able to access the memorable <code class="highlighter-rouge">api.internal</code> domain from our US EC2 instances. So let’s go back and add associate the US VPC with the private hosted zone that we’ve just set up. To do this we need to go back to the “Hosted Zones” page in Route53, and select the radio button next to our <code class="highlighter-rouge">internal</code> zone.</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_17_17_12.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_17_17_12.png" /></p>

<p>If we click in the VPC ID text box then we’ll be presented with the same dropdown box as before, and we can now select the <code class="highlighter-rouge">us-east-1</code> VPC that we’ve been using throughout this post. Select that and hit “Associate New VPC”. This will make the private zone available in both the <code class="highlighter-rouge">us-east-1</code> and <code class="highlighter-rouge">eu-west-1</code> VPCs. 🤯🤯</p>

<p>One quick side note is to take note of the “Important” information box that is shown in the above screenshots as I ignored them initially and lost some time, wondering why I couldn’t see any of the records in my <code class="highlighter-rouge">us-east-1</code> EC2 instance. You’ll need to double check and ensure that DNS Hostnames and DNS Support is supported in all of the VPCs listed in your “associated VPCs” section. To do this go to the VPC console <em>(you’ll need to do this individually for each region, unfortunately).</em></p>

<p>Once you’re in the VPC console select the VPC you would like to check these properties for. When you select it you will see the information box at the bottom of the page which should look something like:</p>

<p><img src="/images/posts/enabling_multi_vpc_communication/Screenshot_2020-01-11_at_17_26_50.png" alt="Enabling%20Multi%20Region%20Restricted%20Communications%20wi/Screenshot_2020-01-11_at_17_26_50.png" /></p>

<p>As you can see the DNS resolution and DNS hostnames are enabled. If, for whatever reason yours are disabled then (with the VPC selected) click on the “Actions” button above the VPC list and click “Edit DNS resolution” or “Edit DNS hostnames” (or both if both are disabled). Tick the checkbox in the next page to enable these properties, and then hit save. Once all of these steps have been completed we should be able to SSH into our <code class="highlighter-rouge">us-east-1</code> EC2 box and execute the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl api.internal/say-hello?name=Angela
</code></pre></div></div>

<p>And we should be given the result <code class="highlighter-rouge">Hello, Angela!</code>.</p>

<p>🎉🎉🎉🎉</p>

<hr />

<p>Well, it’s been a bit of a longer post than I initially intended - but it is my hope that someone who comes across a similar problem has a complete set of actions to fix their issue. Thank you very much for taking the time to read this, I hope it was informative and just a little bit interesting 😊.</p>

<p>I’ll catch you in the next blog post, whenever that may be!</p>

<p>Jamie.</p>

        </div>

        <div class='c-tags'>
          
        </div>

      </article>

    </div>
  </div>
</div>

    
      <section class='disqus'>
  <div id="disqus_thread"></div>
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    var disqus_config = function () {
      this.page.url = "https://jamiemcl.tech//awsvpc/2020/01/11/multi-vpc-communications/"; // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/awsvpc/2020/01/11/multi-vpc-communications/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://jamiemcl-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>                          
</section>
    

    <footer class='c-footer'>
  <div class='o-grid'>
    <div class='o-grid__col o-grid__col--full'>

      <ul class='o-plain-list c-social-nav u-text-center'>
        <li class='c-social-nav__item'>
          <a href='mailto:jamie@jamiemcl.tech' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-envelope' data-size='s'></span>
          </a>
        </li>
        <li class='c-social-nav__item'>
          <a href='https://www.linkedin.com/in/jamiemcleish' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-sc-linkedin' data-size='s'></span>
          </a>
        </li>
        <li class='c-social-nav__item'>
          <a href='https://github.com/jamiemcl001' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-sc-github' data-size='s'></span>
          </a>
        </li>
        <li class='c-social-nav__item'>
          <a href='https://twitter.com/jamie_mcleish' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-sc-twitter' data-size='s'></span>
          </a>
        </li>
        <li class='c-social-nav__item'>
          <a href='https://www.facebook.com/jamiemcleish' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-sc-facebook' data-size='s'></span>
          </a>
        </li>
        <li class='c-social-nav__item'>
          <a href='https://www.instagram.com/jamie_mcleish91/' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-sc-instagram' data-size='s'></span>
          </a>
        </li>
      </ul>

    </div>
  </div>
</footer>
  </div>

  <script src="/js/jquery-3.1.1.min.js"> </script>
  <script src="/js/evil-icons.min.js">   </script>
  <script src="/js/jquery.fitvids.js">   </script>
  <script src="/js/app.js">              </script>

  <script id="dsq-count-scr" src="//jamiemcl-1.disqus.com/count.js" async></script>
</body>

</html>